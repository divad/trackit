{% extends "layout.html" %}
{% block body %}

<div class="page-header">
	{% if repo_admin %}
	{% if repo.state != 4 %}
	<div class="pull-right">
  	<a href="" data-toggle="modal" data-target="#settings" class="btn btn-info" rel="tooltip" data-toggle="tooltip" data-placement="left" title="Edit team settings"><i class="fa fa-fw fa-cog"></i><span class="hidden-xs"> Settings</span></a>		
  	<a href="" data-toggle="modal" data-target="#delete" class="btn btn-danger" rel="tooltip" data-toggle="tooltip" data-placement="left" title="Delete team"><i class="fa fa-fw fa-trash-o"></i><span class="hidden-xs"> Delete</span></a>		
	</div>
	{% else %}
	<div class="alert alert-danger pull-right" role="alert"><i class="fa fa-fw fa-spin fa-cog"></i> This repository is being deleted</div>
	{% endif %}
	{% endif %}
	<h1><span class="fa-stack">
  <i class="fa fa-square fa-stack-2x"></i>
  <i class="fa fa-flag fa-stack-1x fa-inverse"></i>
</span> {{repo.name}}</h1>
	<p>{{repo.desc}}</p>
</div>

{% if repo_admin %}
<div class="modal fade" id="settings">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Repository Settings</h4>
			</div>
			<form class="form-horizontal" role="form" method="POST">
				<div class="modal-body">
					<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
					<input type="hidden" name="action" value="settings"/>

					<div class="form-group" id="form_group_name">
						<label for="inputDescription" class="col-lg-3 control-label">Description</label>
						<div class="col-lg-9">
							<input type="text" class="form-control" id="inputDescription" name="repo_desc" {% if repo.desc %}value="{{ repo.desc }}" {% endif %}>
						</div>
					</div>
					
					<div class="form-group">
						<label for="input_admin" class="col-lg-3 control-label">Visibility</label>
						<div class="col-lg-9">							
							<select name="repo_security" class="form-control" id="input_security">
								<option value="0"{% if repo.security == 0 %} selected="selected"{% endif %}>Private - Only visible to project members</option>
								<option value="1"{% if repo.security == 1 %} selected="selected"{% endif %}>University - Visible to all university members</option>
								<option value="2"{% if repo.security == 2 %} selected="selected"{% endif %}>Public - Visible to anybody on the internet</option>
							</select>

							<span class="help-block">Who can see and logon to the public pages of the project
							</span>
						</div>
					</div>
					
				{% if repo.src_type == 'svn' %}
					
					<div class="form-group">
						<label for="input_admin" class="col-lg-3 control-label">Notify E-Mail</label>
						<div class="col-lg-9">
							<input type="text" class="form-control" id="inputNotify" name="src_notify_email" {% if repo.src_notify_email %}value="{{ repo.src_notify_email }}" {% endif %}>
							<span class="help-block">When commits are made to the repository where should notification e-mails be sent
							</span>
						</div>
					</div>
					
					<div class="form-group">
						<label for="input_admin" class="col-lg-3 control-label">SVN Autoversion</label>
						<div class="col-lg-9">
							<select name="repo_autoversion" class="form-control">
								<option value="0"{% if repo.autoversion == 0 %} selected="selected"{% endif %}>Disabled</option>
								<option value="1"{% if repo.autoversion == 1 %} selected="selected"{% endif %}>Enabled</option>
							</select>
						</div>
					</div>
					
				{% endif %}
					
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Save</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="modal fade" id="delete">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Delete repository</h4>
			</div>
			<form class="form-horizontal" role="form" method="POST">
				<div class="modal-body">
					<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
					<input type="hidden" name="action" value="delete"/>

					<p>Are you sure you want to delete this repository? All data will be lost!</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">No, wait! Cancel!</button>
					<button type="submit" class="btn btn-primary">Yes, proceed!</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script type="text/javascript">
function selectSourceType(sourceType)
{
	if (sourceType == 'internal')
	{
		$('#name-label').text('Username');
		$('#add-title').text('Add account permission');
		$('#ad-alert').addClass('hidden');
	}
	else if (sourceType == 'team')
	{
		$('#name-label').text('Team');
		$('#add-title').text('Add team permission');
		$('#ad-alert').addClass('hidden');
	}
	else if (sourceType == 'adgroup')
	{
		$('#name-label').text('AD Group');
		$('#add-title').text('Add AD group permission');
		$('#ad-alert').removeClass('hidden');
	}
		
	$('#source-name').val(sourceType);
	$('#addperm').modal('hide'); 
	$('#addpermform').modal('show');
}

function goBack()
{
	$('#addpermform').modal('hide');
	$('#addperm').modal('show'); 
}
</script>

<div class="modal" id="addperm">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Add Permission</h4>
			</div>
			<div class="modal-body" stlye="min-height: 200px">
				<button type="button" class="btn btn-primary btn-lg btn-block" onclick="selectSourceType('internal')">University account</button>
				<br/>
				<button type="button" class="btn btn-primary btn-lg btn-block" onclick="selectSourceType('team')">Forge Team</button>
				<br/>
				<button type="button" class="btn btn-primary btn-lg btn-block" onclick="selectSourceType('adgroup')">Active Directory Group</button>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
			</div>
		</div>
	</div>
</div>

<div class="modal" id="addpermform">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<form class="form-horizontal" role="form" method="POST">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="add-title">Add Permission</h4>
				</div>
				<div class="modal-body" stlye="min-height: 200px">
				
					<div class="alert alert-danger hidden" role="alert" id="ad-alert"><strong>Warning!</strong> Granting permissions to active directory groups is not recommended. Nested groups are not supported. Access over SVN+SSH is not supported. Git and Mercurial, though not yet available, are also not supported.</div>

					<input type="hidden" name="_csrf_token" value="{{ csrf_token() }}" />
					<input type="hidden" name="action" value="addperm"/>
					<input type="hidden" name="source" value="internal" id="source-name"/>

					<div class="form-group" id="form_group_name">
						<label for="inputName" class="col-lg-3 control-label" id="name-label">Name</label>
						<div class="col-lg-9">
							<input type="text" class="form-control" name="name">
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-lg-3 control-label">Source Control</label>
						<div class="col-lg-9">							
							<select name="src" class="form-control">
								<option value="0">No access</option>
								<option value="1">Read only</option>
								<option value="2" selected="selected">Read/Write</option>
							</select>

							<span class="help-block">What permission should this user be granted over the source control repository?
							</span>
						</div>
					</div>
					
					<div class="form-group">
						<div class="col-lg-offset-3 col-lg-9">						
							<label>
							  <input name="web" type="checkbox" checked="checked"></input> Access to Trac
							</label>
							<span class="help-block">Should this user be granted access to the web interface?
							</span>
						</div>
						
					</div>
					
					<div class="form-group">
						<div class="col-lg-offset-3 col-lg-9">						
							<label>
							  <input name="admin" type="checkbox"></input> Repository Administrator
							</label>
							<span class="help-block">Should this user be granted administrative rights over this repository?
							</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-warning" onclick="goBack()">Back</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add</button>
					</div>
			</form>
		</div>
	</div>
</div>

{% endif %}


<div class="row">
	<div class="col-md-6">
		<div class="well">
			<h3>About</h3>
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Status</label>
					<div class="col-sm-8">
						<p class="form-control-static">{{ repo.status }}</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Team</label>
					<div class="col-sm-8">
						<p class="form-control-static">
						{% if team %}
						<a href="{{ team.link }}">{{ team.name }}</a>
						{% else %}
						Not part of a team
						{% endif %}
						</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Source Control</label>
					<div class="col-sm-8">
						<p class="form-control-static">
				{% if repo.src_type == 'git' %}
					<span class="label label-primary">GIT</span>
				{% endif %}
				{% if repo.src_type == 'svn' %}
					<span class="label label-primary">SVN</span>
				{% endif %}
				{% if repo.src_type == 'hg' %}
					<span class="label label-primary">HG</span>
				{% endif %}
				{% if repo.src_type == 'none' %}
					<span class="label label-default">N/A</span>
				{% endif %}
					</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Project Management</label>
					<div class="col-sm-8">
						<p class="form-control-static">
				{% if repo.web_type == 'trac' %}
					<span class="label label-info">Trac</span>
				{% endif %}
				{% if repo.web_type == 'redmine' %}
					<span class="label label-info">Redmine</span>
				{% endif %}
				{% if repo.web_type == 'none' %}
					<span class="label label-default">N/A</span>
				{% endif %}
						</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Visibility</label>
					<div class="col-sm-8">
						<p class="form-control-static">{{repo.security}}</p>
					</div>
				</div>
			</form>
		</div>
	</div>

	<div class="col-md-6">
		<div class="well">
			<h3>Links</h3>
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">SVN</label>
					<div class="col-sm-8">
						<p class="form-control-static">https://svn.soton.ac.uk/{{repo.name}}</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">SVN+SSH</label>
					<div class="col-sm-8">
						<p class="form-control-static">ssh+svn://svn.soton.ac.uk/{{repo.name}}</p>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-4 control-label bold-text">Trac</label>
					<div class="col-sm-8">
						<p class="form-control-static">https://trac.soton.ac.uk/{{repo.name}}</p>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="well">
		{% if repo_admin %}
		{% if repo.state != 4 %}
		<div class="pull-right">
	  	<a href="" data-toggle="modal" data-target="#addperm" class="btn btn-success" rel="tooltip" data-toggle="tooltip" data-placement="left" title="Add permission"><i class="fa fa-fw fa-plus"></i><span class="hidden-xs"> Add Permission</span></a>		
		</div>
		{% endif %}
		{% endif %}
		<h3>Permissions</h3>
		<table id="tsort" class="table table-hover table-striped">
			<thead>
				<tr>
					<th width="24%">Name</th>
					<th width="24%">Type</th>
					<th width="24%">Source</th>
					<th width="24%">Web</th>
					<th width="4%"></th>
				</tr>
			</thead>
			<tbody class="rowclick-table">

				<tr>
					<td colspan="5">There are no permissions on this team yet.</td>
				</tr>
			</tbody>
		</table>
		</div>
	</div>
</div>
{% endblock %}
